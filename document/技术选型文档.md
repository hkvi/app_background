# Go语言Web后端项目技术选型文档

## 项目概述

### 项目名称
最小可验证的Web后端系统

### 项目目标
开发一个基于Go语言的轻量级Web后端，实现用户认证和授权功能，包括：
- 用户注册（用户名+密码）
- 用户登录（支持用户名+密码和手机号+验证码两种方式）
- 用户退出
- 受保护的Hello World接口

### 功能需求
1. **用户管理**
   - 用户注册：支持用户名和密码注册
   - 用户登录：支持两种登录方式
     - 用户名+密码登录
     - 手机号+验证码登录
   - 用户退出：清除会话信息

2. **验证码服务**
   - 短信验证码发送
   - 验证码验证和过期管理
   - 防刷机制

3. **接口保护**
   - 登录成功后访问Hello World接口
   - 未登录用户无法访问受保护接口

## 技术栈选择

### 核心框架
- **Gin**: 轻量级Web框架，性能优秀，API简洁
  - 理由：Gin是Go语言中最流行的Web框架之一，具有高性能、易用性和丰富的中间件生态

### 数据库
- **MySQL**: 关系型数据库管理系统
  - 理由：功能强大、性能优秀、社区支持完善
  - 适合生产环境部署，支持高并发访问
  - 提供完整的事务支持和数据完整性约束

### 缓存系统
- **Redis**: 内存数据库，用于验证码存储和会话管理
  - 理由：高性能的键值存储，适合验证码临时存储
  - 支持过期时间设置，自动清理过期验证码
  - 支持分布式部署，适合高并发场景

### 认证方案
- **JWT (JSON Web Token)**: 无状态认证
  - 理由：无需服务器端存储会话信息，适合分布式部署
  - 客户端存储token，减少服务器内存占用
  - 支持多种登录方式的统一认证

### 密码安全
- **bcrypt**: 密码哈希算法
  - 理由：业界标准的密码哈希算法，安全性高
  - Go标准库支持，无需额外依赖

### 短信服务
- **阿里云短信服务**: 企业级短信发送服务
  - 理由：稳定可靠，支持高并发发送
  - 提供完善的API和SDK
  - 支持模板管理和发送统计

### 项目结构
```
project/
├── main.go              # 应用入口
├── config/              # 配置文件
├── handlers/            # HTTP处理器
├── models/              # 数据模型
├── middleware/          # 中间件
├── database/            # 数据库相关
├── services/            # 业务服务层
│   ├── auth_service.go  # 认证服务
│   ├── sms_service.go   # 短信服务
│   └── user_service.go  # 用户服务
├── utils/               # 工具函数
├── cache/               # 缓存相关
└── go.mod               # 依赖管理
```

## 技术架构设计

### 分层架构
1. **表现层 (Presentation Layer)**
   - HTTP路由和请求处理
   - 请求参数验证
   - 响应格式化

2. **业务逻辑层 (Business Logic Layer)**
   - 用户认证逻辑（支持多种登录方式）
   - 短信验证码服务
   - 业务规则处理
   - 数据验证

3. **数据访问层 (Data Access Layer)**
   - 数据库操作
   - 缓存操作
   - 数据模型定义
   - 数据持久化

### 中间件设计
1. **CORS中间件**: 处理跨域请求
2. **日志中间件**: 记录请求日志
3. **认证中间件**: JWT token验证
4. **限流中间件**: 防止验证码接口被刷
5. **错误处理中间件**: 统一错误响应

### 安全考虑
1. **密码安全**: 使用bcrypt进行密码哈希
2. **JWT安全**: 设置合理的过期时间
3. **验证码安全**: 
   - 验证码有效期限制（5分钟）
   - 防刷机制（IP限流）
   - 验证码复杂度（6位数字）
4. **输入验证**: 防止SQL注入和XSS攻击
5. **HTTPS**: 生产环境使用HTTPS

## 依赖包选择

### 核心依赖
```go
require (
    github.com/gin-gonic/gin v1.9.1        // Web框架
    github.com/golang-jwt/jwt/v5 v5.0.0    // JWT处理
    github.com/go-sql-driver/mysql v1.7.1  // MySQL驱动
    github.com/go-redis/redis/v8 v8.11.5   // Redis客户端
    golang.org/x/crypto v0.14.0            // bcrypt密码哈希
    github.com/aliyun/alibaba-cloud-sdk-go v1.62.0 // 阿里云SDK
)
```

### 开发依赖
```go
require (
    github.com/stretchr/testify v1.8.4     // 测试框架
)
```

## API设计

### 接口规范
- **RESTful API**: 遵循REST设计原则
- **JSON格式**: 请求和响应均使用JSON格式
- **HTTP状态码**: 使用标准HTTP状态码

### 接口列表
1. `POST /api/register` - 用户注册（用户名+密码）
2. `POST /api/login` - 用户登录（用户名+密码）
3. `POST /api/sms/send` - 发送短信验证码
4. `POST /api/sms/login` - 手机号+验证码登录
5. `POST /api/logout` - 用户退出
6. `GET /api/hello` - Hello World接口（需要认证）

### 数据模型设计

#### 用户表 (users)
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    phone VARCHAR(20) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_phone (phone)
);
```

#### 验证码表 (sms_codes)
```sql
CREATE TABLE sms_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    phone VARCHAR(20) NOT NULL,
    code VARCHAR(10) NOT NULL,
    type ENUM('login', 'register', 'reset') NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expired_at TIMESTAMP NOT NULL,
    INDEX idx_phone_type (phone, type),
    INDEX idx_expired_at (expired_at)
);
```

## 业务逻辑设计

### 登录流程设计
1. **用户名+密码登录**
   - 验证用户名和密码
   - 生成JWT token
   - 返回token和用户信息

2. **手机号+验证码登录**
   - 验证手机号格式
   - 验证验证码有效性
   - 如果用户不存在，自动创建用户
   - 生成JWT token
   - 返回token和用户信息

### 验证码管理
1. **验证码生成**: 6位随机数字
2. **验证码存储**: Redis存储，5分钟过期
3. **防刷机制**: 
   - 同一手机号1分钟内只能发送1次
   - 同一IP地址1分钟内最多发送10次
4. **验证码验证**: 验证码使用后立即失效

### 用户管理策略
1. **用户名注册**: 传统用户名+密码方式
2. **手机号注册**: 通过验证码登录时自动创建
3. **账号绑定**: 支持用户名和手机号绑定到同一账号

## 开发计划

### 第一阶段：基础框架搭建
1. 初始化Go模块
2. 配置Gin框架
3. 设置基本路由
4. 配置Redis连接

### 第二阶段：数据库设计
1. 创建用户表和验证码表
2. 实现数据库连接
3. 编写数据模型

### 第三阶段：短信服务集成
1. 集成阿里云短信服务
2. 实现验证码发送功能
3. 实现验证码验证逻辑

### 第四阶段：认证功能
1. 实现用户名+密码登录
2. 实现手机号+验证码登录
3. 实现JWT token生成和验证
4. 实现用户注册功能

### 第五阶段：接口保护和安全
1. 实现认证中间件
2. 实现限流中间件
3. 实现Hello World接口
4. 测试认证流程

### 第六阶段：测试和优化
1. 编写单元测试
2. 性能优化
3. 文档完善

## 部署方案

### 开发环境
- 本地运行，使用MySQL数据库
- Redis本地部署
- 端口：8080
- 调试模式开启
- 数据库端口：3306
- Redis端口：6379

### 生产环境
- 使用Docker容器化部署
- 配置环境变量
- 使用HTTPS
- 使用MySQL数据库，支持主从复制和读写分离
- 使用Redis集群，支持高可用

### 环境变量配置
```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=password
DB_NAME=app_background

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# JWT配置
JWT_SECRET=your-secret-key
JWT_EXPIRE_HOURS=24

# 阿里云短信配置
ALIYUN_ACCESS_KEY_ID=your-access-key
ALIYUN_ACCESS_KEY_SECRET=your-secret-key
ALIYUN_SMS_SIGN_NAME=your-sign-name
ALIYUN_SMS_TEMPLATE_CODE=your-template-code
```

## 风险评估

### 技术风险
1. **JWT安全性**: 需要妥善管理密钥和过期时间
2. **数据库性能**: MySQL在高并发下需要合理配置连接池和索引
3. **Redis可用性**: Redis故障会影响验证码功能
4. **短信服务稳定性**: 第三方短信服务可能不稳定
5. **依赖版本**: 需要定期更新依赖包以修复安全漏洞

### 缓解措施
1. 使用强密钥，设置合理的token过期时间
2. 合理配置MySQL连接池，优化SQL查询和索引
3. Redis集群部署，提高可用性
4. 短信服务降级方案，支持邮件验证码备用
5. 定期更新依赖，使用依赖扫描工具

## 兼容性考虑

### 向后兼容
1. **现有用户**: 用户名+密码登录方式保持不变
2. **数据迁移**: 无需数据迁移，新功能为增量添加
3. **API兼容**: 原有API接口保持不变

### 功能扩展
1. **登录方式**: 支持多种登录方式并存
2. **用户绑定**: 支持用户名和手机号绑定
3. **安全增强**: 支持双因素认证

## 总结

本技术选型在原有基础上新增了手机号+验证码登录功能，通过引入Redis缓存和阿里云短信服务，实现了成熟且通用的验证码登录方案。同时保持了与原有用户名+密码登录的完全兼容性，确保现有用户不受影响。通过分层架构和中间件设计，保证了代码的清晰性和功能的模块化，为后续功能扩展奠定了良好的基础。
