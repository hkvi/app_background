# 部署文档

## 环境要求

### 系统要求
- **操作系统**: Linux/Windows/macOS
- **Go版本**: 1.25.0 或更高版本
- **MySQL版本**: 8.0 或更高版本
- **Redis版本**: 6.0 或更高版本

### 硬件要求
- **CPU**: 1核心以上
- **内存**: 2GB以上
- **磁盘**: 10GB以上可用空间

## 环境准备

### 1. 安装Go环境

```bash
# 下载并安装Go
wget https://golang.org/dl/go1.25.0.linux-amd64.tar.gz
tar -C /usr/local -xzf go1.25.0.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin

# 验证安装
go version
```

### 2. 安装MySQL

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server

# CentOS/RHEL
sudo yum install mysql-server

# 启动MySQL服务
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 安全配置
sudo mysql_secure_installation
```

### 3. 安装Redis

```bash
# Ubuntu/Debian
sudo apt install redis-server

# CentOS/RHEL
sudo yum install redis

# 启动Redis服务
sudo systemctl start redis
sudo systemctl enable redis
```

## 项目部署

### 1. 克隆项目

```bash
git clone <项目地址>
cd app_background
```

### 2. 安装依赖

```bash
cd code
go mod download
```

### 3. 配置数据库

```sql
-- 创建数据库
CREATE DATABASE login_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选）
CREATE USER 'login_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON login_db.* TO 'login_user'@'localhost';
FLUSH PRIVILEGES;
```

### 4. 配置文件

复制并修改配置文件：

```bash
cp config.json config.json.backup
```

编辑 `config.json`：

```json
{
  "server": {
    "port": "8080",
    "mode": "release"
  },
  "database": {
    "host": "localhost",
    "port": "3306",
    "username": "login_user",
    "password": "your_password",
    "dbname": "login_db"
  },
  "jwt": {
    "secret_key": "your-super-secret-jwt-key-change-in-production",
    "expire": 3600
  },
  "redis": {
    "host": "localhost",
    "port": "6379",
    "password": "",
    "db": 0
  },
  "sms": {
    "access_key_id": "your-access-key-id",
    "access_key_secret": "your-access-key-secret",
    "sign_name": "your-sign-name",
    "template_code": "your-template-code",
    "region_id": "cn-hangzhou"
  }
}
```

### 5. 环境变量配置（可选）

```bash
export SERVER_PORT=8080
export SERVER_MODE=release
export DB_HOST=localhost
export DB_PORT=3306
export DB_USERNAME=login_user
export DB_PASSWORD=your_password
export DB_NAME=login_db
export JWT_SECRET_KEY=your-super-secret-jwt-key-change-in-production
export JWT_EXPIRE=3600
export REDIS_HOST=localhost
export REDIS_PORT=6379
export REDIS_PASSWORD=
export REDIS_DB=0
export SMS_ACCESS_KEY_ID=your-access-key-id
export SMS_ACCESS_KEY_SECRET=your-access-key-secret
export SMS_SIGN_NAME=your-sign-name
export SMS_TEMPLATE_CODE=your-template-code
export SMS_REGION_ID=cn-hangzhou
```

### 6. 编译项目

```bash
go build -o app main.go
```

### 7. 运行项目

```bash
# 直接运行
./app

# 后台运行
nohup ./app > app.log 2>&1 &

# 使用systemd服务（推荐）
```

## 使用systemd管理服务

### 1. 创建服务文件

```bash
sudo nano /etc/systemd/system/login-app.service
```

### 2. 服务配置

```ini
[Unit]
Description=Login App
After=network.target mysql.service redis.service

[Service]
Type=simple
User=login
WorkingDirectory=/path/to/app_background/code
ExecStart=/path/to/app_background/code/app
Restart=always
RestartSec=5
Environment=GIN_MODE=release

[Install]
WantedBy=multi-user.target
```

### 3. 启动服务

```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start login-app

# 设置开机自启
sudo systemctl enable login-app

# 查看服务状态
sudo systemctl status login-app

# 查看日志
sudo journalctl -u login-app -f
```

## Docker部署

### 1. 创建Dockerfile

```dockerfile
FROM golang:1.25-alpine AS builder

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN go build -o app main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/

COPY --from=builder /app/app .
COPY --from=builder /app/config.json .

EXPOSE 8080
CMD ["./app"]
```

### 2. 创建docker-compose.yml

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DB_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: login_db
      MYSQL_USER: login_user
      MYSQL_PASSWORD: userpassword
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"
    restart: unless-stopped

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"
    restart: unless-stopped

volumes:
  mysql_data:
```

### 3. 启动服务

```bash
docker-compose up -d
```

## 监控和日志

### 1. 日志配置

项目使用内置的日志系统，日志会输出到控制台。在生产环境中，建议配置日志轮转：

```bash
# 使用logrotate
sudo nano /etc/logrotate.d/login-app

/path/to/app_background/code/app.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 login login
    postrotate
        systemctl reload login-app
    endscript
}
```

### 2. 健康检查

```bash
# 检查服务状态
curl http://localhost:8080/api/health

# 预期响应
{
  "status": "ok",
  "timestamp": "2024-01-01T12:00:00Z"
}
```

### 3. 性能监控

可以使用以下工具进行监控：

- **Prometheus + Grafana**: 监控系统指标
- **ELK Stack**: 日志收集和分析
- **New Relic**: 应用性能监控

## 安全配置

### 1. 防火墙配置

```bash
# 只开放必要端口
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 8080/tcp  # 应用端口
sudo ufw enable
```

### 2. SSL/TLS配置

在生产环境中，建议使用HTTPS：

```bash
# 使用Nginx作为反向代理
sudo apt install nginx
sudo certbot --nginx -d your-domain.com
```

### 3. 数据库安全

```sql
-- 限制数据库访问
GRANT SELECT, INSERT, UPDATE, DELETE ON login_db.* TO 'login_user'@'localhost';
REVOKE ALL PRIVILEGES ON login_db.* FROM 'login_user'@'%';
```

## 备份和恢复

### 1. 数据库备份

```bash
# 创建备份脚本
#!/bin/bash
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u login_user -p login_db > $BACKUP_DIR/login_db_$DATE.sql

# 添加到crontab
0 2 * * * /path/to/backup_script.sh
```

### 2. 应用备份

```bash
# 备份应用文件
tar -czf app_backup_$(date +%Y%m%d).tar.gz /path/to/app_background/
```

## 故障排除

### 1. 常见问题

**问题**: 数据库连接失败
```bash
# 检查MySQL服务状态
sudo systemctl status mysqld

# 检查数据库连接
mysql -u login_user -p -h localhost
```

**问题**: Redis连接失败
```bash
# 检查Redis服务状态
sudo systemctl status redis

# 测试Redis连接
redis-cli ping
```

**问题**: 端口被占用
```bash
# 查看端口占用
netstat -tlnp | grep 8080

# 杀死占用进程
sudo kill -9 <PID>
```

### 2. 日志分析

```bash
# 查看应用日志
tail -f app.log

# 查看系统日志
sudo journalctl -u login-app -f

# 查看错误日志
grep ERROR app.log
```

## 更新部署

### 1. 代码更新

```bash
# 拉取最新代码
git pull origin main

# 重新编译
go build -o app main.go

# 重启服务
sudo systemctl restart login-app
```

### 2. 数据库迁移

```bash
# 备份当前数据
mysqldump -u login_user -p login_db > backup.sql

# 执行迁移脚本
mysql -u login_user -p login_db < migration.sql
```

## 性能优化

### 1. 数据库优化

```sql
-- 添加索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_phone ON users(phone);

-- 优化查询
EXPLAIN SELECT * FROM users WHERE username = 'testuser';
```

### 2. Redis优化

```bash
# 配置Redis内存
maxmemory 256mb
maxmemory-policy allkeys-lru
```

### 3. 应用优化

```bash
# 设置GOMAXPROCS
export GOMAXPROCS=4

# 启用GC优化
export GOGC=100
```
